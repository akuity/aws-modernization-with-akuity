version: 0.2

phases:
  install:
    runtime-versions:
      docker: 18
      dotnet: 2.2
      python: 3.7
      ruby: 2.6

  pre_build:
    commands:
      - COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
      - IMAGE_TAG=${COMMIT_HASH:=latest}

      - echo "Initializing Git Repo"
      - git init
      - git remote add origin $FULL_REPO_URL
      - git fetch
      - git checkout -f "$CODEBUILD_RESOLVED_SOURCE_VERSION"

      - echo "Updating GitHub SSH host key..."
      - ssh-keygen -R github.com || true
      - ssh-keyscan github.com >> /root/.ssh/known_hosts

      - echo "Updating submodule URL to use HTTPS..."
      - git config --global url."https://github.com/".insteadOf "git@github.com:"

      - echo "Initializing and updating Git submodules..."
      - git submodule update --init --recursive

      - echo "Checking if theme exists in the correct path..."
      - if [ ! -d "themes/hugo-theme-learn" ]; then 
          rm -rf themes/hugo-theme-learn && 
          git clone https://github.com/aws-samples/aws-modernization-workshop-base.git themes/hugo-theme-learn;
        fi

      - echo "Initializing Hugo Modules..."
      - hugo mod init || true
      - hugo mod get -u || true

      - echo "Installing dependencies..."
      - gem install asciidoctor

      - echo "Installing Hugo..."
      - wget https://github.com/gohugoio/hugo/releases/download/v0.71.0/hugo_extended_0.71.0_Linux-64bit.tar.gz
      - tar -xzf hugo_extended_0.71.0_Linux-64bit.tar.gz
      - mv hugo /usr/local/bin/hugo
      - hugo version

  build:
    commands:
      - echo "Checking theme directory:"
      - ls -lar themes/hugo-theme-learn/

      - echo "Building Website..."
      - hugo -D -d public

      - echo "Deploying Website to S3..."
      - aws s3 sync public/ s3://${WEB_SITE_BUCKET}/ --delete
      
      - echo "Invalidating CloudFront Cache..."
      - aws cloudfront create-invalidation --distribution-id ${CLOUDFRONT_DISTRO_ID} --paths "/*"
